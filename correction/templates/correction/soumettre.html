{% block content %}
<style>
.quick-nav { width: 100%; max-width: 540px; margin: 0 auto 1.1em auto; display: flex; justify-content: center; gap: 1em; flex-wrap: wrap;}
.quick-btn { background: #00a484; color: #fff; font-size: 1.08em; font-weight: 600; border: none; border-radius: 25px; padding: 0.44em 1.2em 0.46em 1.2em; margin:0; box-shadow: 0 1px 6px #00806044; cursor: pointer; text-decoration: none; display: inline-block; transition: background .18s, color .18s, box-shadow .2s;}
.quick-btn:hover, .quick-btn:focus { background: #008060; color: #efefef;}
@media (max-width: 700px) { .quick-nav { max-width:98vw; gap:0.32em;} .quick-btn { width: 95vw; max-width:99vw; text-align:center; margin: 0.09em auto;}}
body { background: #f9fcf7; }
.form-section { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); padding: 2rem 1.5rem; max-width: 540px; margin: 2rem auto;}
.form-header { color: #008060; font-weight: 700; font-size: 2em; letter-spacing: 1px; margin-bottom: 1.5rem; text-align: center;}
label { color: #008060; font-weight: 500; margin-top: 1rem; display: block; margin-bottom: 0.5rem;}
select, input[type="file"] { width: 100%; border: 1.5px solid #008060; border-radius: 5px; padding: 0.6em; margin-bottom: 1.2em; background: #f6fefb; font-size: 1em; transition: border-color 0.2s;}
select:disabled, input:disabled { opacity: 0.7; cursor: not-allowed; background: #e3f2ed; }
button.submit-btn { width: 100%; background: #008060; color: #fff; font-weight: 600; font-size: 1.2em; border: none; border-radius: 5px; padding: 0.8em 0.5em; margin-top: 1em; cursor: pointer; transition: background 0.3s;}
button.submit-btn:hover { background: #00a484; }
.lecon-checkbox-block { margin: 8px 0 18px 0; padding: 0.75em; background: #f6fefb; border-radius: 6px;}
.lecon-checkbox { accent-color: #008060; width: 1.1em; height: 1.1em; margin-right: 0.7em;}
.lecon-label { display: flex; align-items: center; margin-bottom: 0.5em; font-size: 1em; color: #134c33; }
.file-help { margin-top: -6px; margin-bottom: 10px; font-size: 0.95em; color: #00695f; display: block;}
@media (max-width: 700px) { .form-section { max-width: 99vw; padding: 1.2rem 0.5rem; } .form-header { font-size: 1.35em; } .file-help { font-size: 0.93em;}}
</style>
<div class="quick-nav">
    <a href="{% url 'correction:soumettre' %}" class="quick-btn">corriger un sujet avec CIS</a>
    <a href="{% url 'correction:historique' %}" class="quick-btn">Historique</a>
    <a href="{% url 'correction:login' %}" class="quick-btn">D√©connexion</a>
    <a href="{% url 'correction:profil' %}" class="quick-btn">Mon profil</a>


{% if user.is_authenticated and user.role == 'prof' %}
    <a href="{% url 'correction:espace_prof' %}" class="quick-btn">Espace Prof</a>
{% endif %}
    {% if user.is_authenticated and user.role == 'admin' %}
    <a href="{% url 'correction:admin_dashboard' %}" class="quick-btn">Dashboard admin</a>
{% endif %}
</div>
<div class="form-section">
    <div class="form-header">üì§ Soumettre un exercice</div>
    {% if credit_restants > 0 %}
    <div style="color:#008060; font-weight:600; margin-bottom:1.2em;">
        Cr√©dits restants‚ÄØ: {{ credit_restants }}
    </div>
{% else %}
    <div style="color:red; font-weight:600; margin-bottom:1.2em;">
        Vous n'avez plus de cr√©dits d'abonnement. Veuillez activer ou renouveler votre abonnement !
    </div>
{% endif %}
    <form method="post" enctype="multipart/form-data" id="soumission-form" autocomplete="off">
        {% csrf_token %}
        <label for="id_pays">Pays</label>
        {{ form.pays }}

        <label for="id_sous_systeme">Sous-syst√®me</label>
        {{ form.sous_systeme }}

        <label for="id_departement">D√©partement</label>
        {{ form.departement }}

        <label for="id_classe">Classe</label>
        {{ form.classe }}

        <label for="id_matiere">Mati√®re</label>
        {{ form.matiere }}

        <label for="id_type_exercice">Type d'exercice</label>
        {{ form.type_exercice }}

        <label for="id_fichier">Fichier de l'exercice (PDF, photo, image)</label>
        <input type="file" name="fichier" id="id_fichier"
               accept=".pdf, image/*"
               capture="environment"
               style="width:100%;border:1.5px solid #008060;border-radius:5px;padding:0.6em;margin-bottom:0.35em;background:#f6fefb;">
        <span class="file-help">
            Sur mobile, ton appareil photo s‚Äôouvrira automatiquement. <br>
            Prends une photo nette, bien √©clair√©e & de texte imprim√© si possible.<br>
            Sur ordinateur, tu peux choisir un fichier PDF, JPG ou PNG.
        </span>
        <button type="submit" class="submit-btn" {% if credit_restants == 0 %}disabled
                style="opacity:0.7;cursor:not-allowed"{% endif %}>Soumettre</button>
        <div id="bloc-lecons" class="lecon-checkbox-block" style="display:none;"></div>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function resetSelect(select) {
        if (!select) return;
        select.innerHTML = '';
        select.appendChild(new Option('S√©lectionner...', ''));
        select.disabled = true;
    }
    function fillSelect(select, dataArray, placeholder='S√©lectionner...') {
        select.innerHTML = '';
        select.appendChild(new Option(placeholder, ''));
        dataArray.forEach(item => {
            select.appendChild(new Option(item.nom || item.titre || item.label, item.id));
        });
        select.disabled = false;
    }

    const paysSelect = document.getElementById('id_pays');
    const ssSelect = document.getElementById('id_sous_systeme');
    const departementSelect = document.getElementById('id_departement');
    const classeSelect = document.getElementById('id_classe');
    const matiereSelect = document.getElementById('id_matiere');
    const typeExoSelect = document.getElementById('id_type_exercice');
    const leconsBloc = document.getElementById('bloc-lecons');

    // --- AUTOLOAD DES D√âPENDANCES SI D√âJ√Ä PR√â-REMPLIES ---
    function cascadeAutoLoad() {
        // 1. Charger sous-syst√®me et d√©partement si pays choisi
        if (paysSelect.value) {
            fetch(`/correction/ajax/sous-systemes/?pays_id=${paysSelect.value}`)
                .then(r=>r.json())
                .then(data=>{
                    fillSelect(ssSelect, data, 'S√©lectionner un sous-syst√®me');
                    if (ssSelect.value && ssSelect.value !== '' && ssSelect.options.length > 1) {
                        ssSelect.value = '{{ form.sous_systeme.value }}';
                    }
                    // Apr√®s sous-syst√®me ‚Üí charger classes
                    if (ssSelect.value) {
                        fetch(`/correction/ajax/classes/?ss_id=${ssSelect.value}`)
                            .then(r=>r.json())
                            .then(data2=>{
                                fillSelect(classeSelect, data2, 'S√©lectionner une classe');
                                if (classeSelect.value && classeSelect.value !== '' && classeSelect.options.length > 1) {
                                    classeSelect.value = '{{ form.classe.value }}';
                                }
                                // Charger mati√®res si classe pr√©remplie
                                if (classeSelect.value) {
                                    fetch(`/correction/ajax/matieres/?classe_id=${classeSelect.value}`)
                                        .then(r=>r.json())
                                        .then(data3=>{
                                            fillSelect(matiereSelect, data3, 'S√©lectionner une mati√®re');
                                            if (matiereSelect.value && matiereSelect.value !== '' && matiereSelect.options.length > 1) {
                                                matiereSelect.value = '{{ form.matiere.value }}';
                                            }
                                        });
                                }
                            });
                    }
                });
            // Charger d√©partement √† part
            fetch(`/correction/ajax/departements/?pays_id=${paysSelect.value}`)
                .then(r=>r.json())
                .then(data=>{
                    fillSelect(departementSelect, data, 'S√©lectionner un d√©partement');
                    if (departementSelect.value && departementSelect.value !== '' && departementSelect.options.length > 1) {
                        departementSelect.value = '{{ form.departement.value }}';
                    }
                    // Charger type_exo si d√©partement pr√©rempli
                    if (departementSelect.value) {
                        fetch(`/correction/ajax/types-exercices/?departement_id=${departementSelect.value}`)
                            .then(r=>r.json())
                            .then(data2=>{
                                fillSelect(typeExoSelect, data2, 'S√©lectionner un type d\'exercice');
                                if (typeExoSelect.value && typeExoSelect.value !== '' && typeExoSelect.options.length > 1) {
                                    typeExoSelect.value = '{{ form.type_exercice.value }}';
                                }
                            });
                    }
                });
        }
    }

    // Appeler cascadeAutoLoad juste apr√®s le chargement¬†:
    cascadeAutoLoad();

    // --- √âcouteurs AJAX normaux pour modifications utilisateur ---
    paysSelect.addEventListener('change', function() {
        let val = paysSelect.value;
        resetSelect(ssSelect); resetSelect(departementSelect);
        resetSelect(classeSelect); resetSelect(matiereSelect);
        resetSelect(typeExoSelect);
        leconsBloc.style.display = "none"; leconsBloc.innerHTML = '';
        if (!val) return;
        fetch(`/correction/ajax/sous-systemes/?pays_id=${val}`)
            .then(r=>r.json()).then(data=>fillSelect(ssSelect, data, 'S√©lectionner un sous-syst√®me'));
        fetch(`/correction/ajax/departements/?pays_id=${val}`)
            .then(r=>r.json()).then(data=>fillSelect(departementSelect, data, 'S√©lectionner un d√©partement'));
    });

    ssSelect && ssSelect.addEventListener('change', function() {
        let val = ssSelect.value;
        resetSelect(classeSelect); resetSelect(matiereSelect);
        resetSelect(typeExoSelect);
        leconsBloc.style.display = "none"; leconsBloc.innerHTML = '';
        if (!val) return;
        fetch(`/correction/ajax/classes/?ss_id=${val}`)
            .then(r=>r.json()).then(data=>fillSelect(classeSelect, data, 'S√©lectionner une classe'));
    });

    classeSelect && classeSelect.addEventListener('change', function() {
        let val = classeSelect.value;
        resetSelect(matiereSelect);
        leconsBloc.style.display = "none"; leconsBloc.innerHTML = '';
        if (!val) return;
        fetch(`/correction/ajax/matieres/?classe_id=${val}`)
            .then(r=>r.json()).then(data=>fillSelect(matiereSelect, data, 'S√©lectionner une mati√®re'));
    });

    departementSelect && departementSelect.addEventListener('change', function() {
        let val = departementSelect.value;
        resetSelect(typeExoSelect);
        if (!val) return;
        fetch(`/correction/ajax/types-exercices/?departement_id=${val}`)
            .then(r=>r.json()).then(data=>fillSelect(typeExoSelect, data, "S√©lectionner un type d'exercice"));
    });

    matiereSelect && matiereSelect.addEventListener('change', function() {
        let val = matiereSelect.value;
        leconsBloc.style.display = "none"; leconsBloc.innerHTML = '';
        if (!val) return;
        fetch(`/correction/ajax/lecons/?matiere_id=${val}`)
            .then(r=>r.json())
            .then(data=>{
                if(data.length > 0) {
                    leconsBloc.innerHTML = `<div style="margin-bottom:8px;color:#008060;font-weight:600;">Am√©liorez votre corrig√© en cochant les le√ßons √©valu√©es dans votre sujet (facultatif)</div>`;
                    data.forEach(item => {
                        leconsBloc.innerHTML += `
                            <label class="lecon-label">
                                <input type="checkbox" name="lecons" value="${item.id}" class="lecon-checkbox"/>
                                <span>${item.titre}</span>
                            </label>
                        `;
                    });
                    leconsBloc.style.display = "";
                } else {
                    leconsBloc.innerHTML = "";
                    leconsBloc.style.display = "none";
                }
            });
    });

});
</script>
{% endblock %}