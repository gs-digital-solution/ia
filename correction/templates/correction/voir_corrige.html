{% block content %}

<!-- ----------- STYLES ------------- -->
<style>
.quick-nav {
    width: 100%;
    max-width: 540px;
    margin: 0 auto 1.1em auto;
    display: flex;
    justify-content: center;
    gap: 1em;
    flex-wrap: wrap;
}
.quick-btn {
    background: #00a484;
    color: #fff;
    font-size: 1.08em;
    font-weight: 600;
    border: none;
    border-radius: 25px;
    padding: 0.44em 1.2em 0.46em 1.2em;
    margin:0;
    box-shadow: 0 1px 6px #00806044;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: background .18s, color .18s, box-shadow .2s;
}
.quick-btn:hover, .quick-btn:focus {
    background: #008060;
    color: #efefef;
}
@media (max-width: 700px) {
    .quick-nav { max-width:98vw; gap:0.32em;}
    .quick-btn { width: 95vw; max-width:99vw; text-align:center; margin: 0.09em auto;}
}
.corrige-section {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    max-width: 540px;
    margin: 2rem auto;
    padding: 1.1rem 1.3rem;
    text-align: center;
}
.corrige-header {
    color: #008060;
    font-weight: 700;
    font-size: 1.5em;
    margin-bottom: 18px;
    text-align: center;
}
.corrige-bloc {
    background: #fff;
    border-radius: 7px;
    padding: 0.3em 0.7em 0.4em 0.7em;
    margin-bottom: 0.15em;
    color: #111;
    word-break: break-word;
    display: block;
    text-align: left;
    max-width: 100%;
    font-size: 1.07em;
    white-space: pre-line;
    line-height: 1.07;
    border: 1px solid #f0f0f0;
}
.btn-zone-pdf-noch {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25em;
    margin: 0.7em 0 0.2em 0;
}
a.django-link { color:#008060; text-decoration:underline; }
a.django-link:hover { color: #00a484; }
.btn-retour, #pdfBtn {
    background:#008060;
    color:#fff;
    padding:0.39em 1.12em;
    margin:0;
    border-radius:5px;
    border:none;
    cursor:pointer;
    font-weight:550;
    display: block;
    font-size: 1.03em;
    width: 100%;
    margin-bottom: 0.11em;
    box-sizing: border-box;
}
.btn-retour:hover, #pdfBtn:hover {background:#00a484;}
@media print {
    .btn-retour, #pdfBtn, nav, .navbar, header, footer { display: none !important; }
    body, .corrige-section, .corrige-bloc { background: #fff !important; color: #111 !important; }
    .corrige-section { margin: 0 !important; padding: 0.6em 0.2em !important; box-shadow: none !important; }
    .corrige-header { font-size: 1.14em !important; color: #111 !important; }
    a.django-link { color: #111 !important; text-decoration: underline !important; }
}
.feedback-section {margin-top:2.2em;padding:1.15em 0;border-top:1.3px solid #c2e7d5;text-align:center;}
.feedback-success {color:#1c7c40;font-weight:700;background:#e1fae5;border-radius:6px;padding:0.55em 1.18em;display:inline-block;}
.submit-btn { margin-top:0.7em;width:auto;}
</style>

<!-- ----------- NAV BAR ------------- -->
<div class="quick-nav">
    <a href="{% url 'correction:soumettre' %}" class="quick-btn">corriger un sujet avec CIS</a>
    <a href="{% url 'correction:historique' %}" class="quick-btn">Historique</a>
    <a href="{% url 'correction:profil' %}" class="quick-btn">Mon profil</a>
    <a href="{% url 'correction:login' %}" class="quick-btn">D√©connexion</a>
    {% if user.is_authenticated and user.role == 'admin' %}
        <a href="{% url 'correction:admin_dashboard' %}" class="quick-btn">Dashboard admin</a>
    {% endif %}
</div>

<!-- ----------- ZONE DE CORRIGE ------------- -->
<div class="corrige-section">
    <div class="corrige-header">Corrig√© g√©n√©r√©</div>
    <div style="margin-bottom:2px;">
        <b>Date de soumission‚ÄØ:</b> {{ demande.date_soumission|date:"d/m/Y H:i" }}
    </div>
    <div class="corrige-bloc" style="margin-bottom: 0.07em;">
        <b>Fichier de l‚Äô√©nonc√©‚ÄØ:</b>
        {% if demande.fichier %}
            <a class="django-link" href="{{ demande.fichier.url }}" target="_blank">{{ demande.fichier.name }}</a>
        {% else %}
            Aucun fichier joint.
        {% endif %}
    </div>
    <div class="corrige-bloc" style="margin-top: 0.01em;">
        <b>Corrig√©‚ÄØ:</b>
        <!-- ‚úÖ PATCH ICI‚ÄØ: retrait du filtre linebreaksbr -->
        <div id="zone-corrige">{% autoescape off %}{{ demande.corrig√© }}{% endautoescape %}</div>
    </div>
    <div class="btn-zone-pdf-noch">
        {% if pdf_enabled %}
            <button id="pdfBtn" type="button">T√©l√©charger/Enregistrer en PDF</button>
        {% endif %}
        <a href="{% url 'correction:soumettre' %}" class="btn-retour">‚Üê Soumettre un autre exercice</a>
    </div>
</div>

<!-- ----------- FEEDBACK UTILISATEUR ------------- -->
<div class="feedback-section">
    <h4 style="color:#098f56; font-size:1.13em;">Votre avis sur ce corrig√©</h4>
    {% if user.is_authenticated %}
        {% if has_feedback %}
            <div class="feedback-success">
                Merci pour votre avis !
            </div>
        {% else %}
            <form method="post" action="{% url 'correction:donner_feedback' correction.id %}" style="margin-bottom:0;">
                {% csrf_token %}
                {{ form.note.errors }}
                <div style="margin-bottom: 1.2em;">
                  <b>Note‚ÄØ:</b> {{ form.note }}
                </div>
                <div>
                    {{ form.comment.label_tag }}<br>
                    {{ form.comment }}
                </div>
                <button class="submit-btn">Envoyer le feedback</button>
            </form>
        {% endif %}
    {% else %}
        <div><a href="{% url 'correction:login' %}">Connectez-vous pour donner votre avis</a></div>
    {% endif %}
</div>

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['\\[', '\\]']],
  },
  svg: { fontCache: 'global' }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById("pdfBtn");
    if(btn){
        btn.addEventListener('click', function(){
            window.print();
        });
        if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
            btn.addEventListener('click', function(){
                setTimeout(function(){
                    alert("Astuce‚ÄØ: Sur mobile, apr√®s avoir lanc√© l'impression, choisissez 'Enregistrer en PDF' ou 'Partager', puis consultez le PDF dans T√©l√©chargements/Fichiers.");
                }, 700);
            });
        }
    }

    // üëâ Si zone-corrige contenu dynamique, on peut forcer MathJax¬†:
    if(window.MathJax && window.MathJax.typeset){
        window.MathJax.typeset();
    }
});
</script>
{% endblock %}